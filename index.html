<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>CubeTimer+ Trainer (WCA) ‚Äî Kodex</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#111827">
<style>
  :root{ --bg:#0b0f19; --panel:#121826; --panel-2:#0e1523; --text:#e5e7eb; --muted:#9ca3af;
         --accent:#22d3ee; --good:#34d399; --warn:#f59e0b; --bad:#ef4444; --chip:#1f2937; }
  .theme-cyan{ --accent:#22d3ee; --bg:#0b0f19; --panel:#121826; }
  .theme-violet{ --accent:#a78bfa; --bg:#0b0b17; --panel:#16162a; }
  .theme-emerald{ --accent:#34d399; --bg:#071411; --panel:#0e1c18; }
  .theme-rose{ --accent:#fb7185; --bg:#190b12; --panel:#26121c; }
  .theme-amber{ --accent:#fbbf24; --bg:#1a1207; --panel:#24190a; }

  html,body{height:100%;}
  body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
  .wrap{max-width:1100px; margin:0 auto; padding:16px;}
  header{display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; justify-content:space-between; margin-bottom:12px;}
  .left,.right{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  select,button,input[type="number"],input[type="text"]{
    background:var(--panel); color:var(--text); border:1px solid #27324a; border-radius:10px; padding:10px 12px; font-size:14px;}
  button.primary{ background:var(--accent); color:#0a0a0a; border:none; font-weight:700; }
  button.ghost{ background:var(--chip); }
  .chip{ background:var(--chip); padding:6px 10px; border-radius:999px; color:var(--muted); }
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px;}
  .tabs button{ padding:10px 14px; border-radius:12px; background:var(--panel); border:1px solid #27324a; color:var(--text);}
  .tabs button.active{ background:var(--accent); color:#0a0a0a; border:none; font-weight:700;}
  .grid{ display:grid; gap:12px;}
  @media (min-width:900px){ .grid-2{ grid-template-columns:1.2fr .8fr; } }
  .card{ background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid #27324a; border-radius:16px; padding:14px;}
  .title{ font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:8px;}
  .scramble{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:16px; line-height:1.4; }
  .timer{ font-size:64px; text-align:center; padding:24px 0; user-select:none; }
  .tapzone{ height:160px; display:flex; align-items:center; justify-content:center;
            border:1px dashed #27324a; border-radius:12px; background:#0d1322; margin:8px 0; }
  .tapzone .hint{ color:var(--muted); font-size:12px; margin-top:6px; text-align:center; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .subgrid{ display:grid; gap:8px; grid-template-columns:1fr 1fr 1fr; }
  .subgrid .card{ padding:10px; }
  .stat{ font-size:22px; font-weight:700;}
  .muted{ color:var(--muted); }
  .list{ max-height:220px; overflow:auto; font-family: ui-monospace, Menlo, monospace; font-size:13px; }
  .list div{ padding:6px 8px; border-bottom:1px dashed #27324a; display:flex; justify-content:space-between; gap:8px;}
  .k{ color:#93c5fd;} .v{ color:#fcd34d;}
  .pill{ padding:4px 8px; border-radius:999px; font-size:12px;} .ok{ background:#063; } .ko{ background:#5a1a1a; }
  .bar{ height:8px; background:#111827; border:1px solid #27324a; border-radius:999px; overflow:hidden; }
  .bar > b{ display:block; height:100%; background:var(--accent); width:0%; }
  .row-between{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#0f172a; border:1px solid #27324a; padding:10px 14px; border-radius:10px; display:none; }
</style>
</head>
<body class="theme-cyan">
<div class="wrap">
  <header>
    <div class="left">
      <select id="profileSelect" title="Profil"></select>
      <button id="addProfileBtn" class="ghost">+ Profil</button>
      <span class="chip" id="pointsChip">üèÜ 0 pts</span>
      <span class="chip" id="leagueChip">Ligue 1</span>
    </div>
    <div class="right">
      <select id="puzzleSelect" title="Puzzle">
        <option value="222">2√ó2√ó2</option><option value="333">3√ó3√ó3</option>
        <option value="444">4√ó4√ó4</option><option value="555">5√ó5√ó5</option>
        <option value="666">6√ó6√ó6</option><option value="777">7√ó7√ó7</option>
        <option value="pyram">Pyraminx</option><option value="skewb">Skewb</option>
        <option value="mega">Megaminx</option><option value="clock">Clock</option>
        <option value="sq1">Square-1</option>
      </select>
      <select id="themeSelect" title="Th√®me">
        <option value="theme-cyan">Cyan</option>
        <option value="theme-violet">Violet</option>
        <option value="theme-emerald">√âmeraude</option>
        <option value="theme-rose">Rose</option>
        <option value="theme-amber">Ambre</option>
      </select>
      <button id="settingsBtn" class="ghost">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="tabs">
    <button data-tab="timer" class="active">Timer</button>
    <button data-tab="trainer">Trainer</button>
    <button data-tab="challenge">Challenge</button>
    <button data-tab="history">Historique</button>
  </div>

  <!-- TIMER -->
  <section id="tab-timer">
    <div class="grid grid-2">
      <div class="card">
        <div class="row-between">
          <div>
            <div class="title">Scramble</div>
            <div id="scramble" class="scramble">Clique ‚ÄúNouveau scramble‚Äù</div>
          </div>
          <div class="row">
            <button id="newScrambleBtn" class="primary">Nouveau scramble</button>
            <label class="row" style="gap:6px;">
              <input id="inspectionToggle" type="checkbox"> Inspection (<span id="inspSecLabel">15</span>s)
            </label>
          </div>
        </div>

        <!-- ZONE DE TAP AU MILIEU -->
        <div id="tapZone" class="tapzone">
          <div>
            <div class="timer" id="timerDisplay">00.00</div>
            <div class="hint">Tape ici (ou barre d‚Äôespace) pour START / STOP</div>
          </div>
        </div>

        <div class="row" style="justify-content:center; gap:10px;">
          <button id="startStopBtn" class="primary">Start/Stop</button>
          <button id="dnfBtn" class="ghost">DNF</button>
          <button id="plus2Btn" class="ghost">+2</button>
          <button id="saveBtn" class="ghost">Sauver</button>
          <button id="delLastBtn" class="ghost">Suppr dernier</button>
        </div>
      </div>

      <div class="card">
        <div class="title">Stats</div>
        <div class="subgrid">
          <div class="card"><div class="muted">Dernier</div><div id="stat-last" class="stat">‚Äî</div></div>
          <div class="card"><div class="muted">PB</div><div id="stat-pb" class="stat">‚Äî</div></div>
          <div class="card"><div class="muted">Ao5 / Ao12</div><div class="stat"><span id="stat-ao5">‚Äî</span> / <span id="stat-ao12">‚Äî</span></div></div>
        </div>
        <div style="margin-top:12px;">
          <div class="muted" style="margin-bottom:6px;">Progression troph√©es</div>
          <div class="bar"><b id="trophyBar" style="width:0%"></b></div>
          <div class="muted" id="trophyText">0 / 100 pts pour Ligue 2</div>
        </div>
        <div style="margin-top:12px;">
          <div class="muted" style="margin-bottom:6px;">Derniers solves</div>
          <div id="recentList" class="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- TRAINER -->
  <section id="tab-trainer" style="display:none;">
    <div class="grid grid-2">
      <div class="card">
        <div class="title">Ajouter / √©diter un algorithme</div>
        <div class="trainer-form">
          <input id="algName" type="text" placeholder="Nom du cas (ex: CLL U R-perm)">
          <textarea id="algMoves" placeholder="Mouvements (ex: R U R' U')"></textarea>
          <input id="algScramble" type="text" placeholder="Scramble optionnel">
          <div class="row" style="margin-top:8px;">
            <button id="saveAlgBtn" class="primary">Enregistrer</button>
            <button id="clearAlgBtn" class="ghost">Effacer</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="title">Mes algos</div>
        <div id="algList" class="list"></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <div class="row-between">
        <div>
          <div class="title">Session Trainer</div>
          <div id="trainerScramble" class="scramble">Choisis un algo ci-dessus</div>
        </div>
        <div class="row">
          <button id="trainerNew" class="primary">Nouveau cas</button>
          <button id="trainerReveal" class="ghost">R√©v√©ler l‚Äôalgo</button>
          <button id="trainerOk" class="ghost">R√©ussi</button>
          <button id="trainerKo" class="ghost">Rat√©</button>
        </div>
      </div>
      <div id="trainerSolution" class="muted" style="margin-top:6px;">Solution masqu√©e</div>
      <div style="margin-top:8px;">
        <span class="pill ok" id="trainerOkRate">OK: 0</span>
        <span class="pill ko" id="trainerKoRate">KO: 0</span>
      </div>
    </div>
  </section>

  <!-- CHALLENGE -->
  <section id="tab-challenge" style="display:none;">
    <div class="grid grid-2">
      <div class="card">
        <div class="title">Modes jouables</div>
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <button id="modeBlind" class="ghost">Blindfold (scramble 5s)</button>
          <button id="modeEndu5" class="ghost">Endurance 5min</button>
          <button id="modeEndu15" class="ghost">Endurance 15min</button>
          <button id="modeEndu60" class="ghost">Endurance 60min</button>
          <button id="modeChallenge" class="primary">Challenge (paliers)</button>
          <button id="stopModes" class="ghost">Arr√™ter mode</button>
        </div>
        <div id="challengeInfo" class="muted" style="margin-top:8px;">Aucun mode actif.</div>
      </div>
      <div class="card">
        <div class="title">R√©compenses & succ√®s</div>
        <div id="rewardBox" class="muted">Fais des solves pour gagner des points, d√©bloquer des paliers & succ√®s.</div>
      </div>
    </div>
  </section>

  <!-- HISTORIQUE -->
  <section id="tab-history" style="display:none;">
    <div class="card">
      <div class="row-between">
        <div class="title">Historique (profil & puzzle courants)</div>
        <div class="row">
          <button id="exportBtn" class="ghost">Exporter JSON</button>
          <button id="importBtn" class="ghost">Importer JSON</button>
          <input id="importFile" type="file" style="display:none" accept="application/json">
        </div>
      </div>
      <div id="historyList" class="list"></div>
    </div>
  </section>
</div>

<!-- DIALOG REGLAGES -->
<div id="settings" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4);">
  <div class="card" style="width:min(560px,92vw)">
    <div class="row-between">
      <div class="title">R√©glages</div>
      <button id="closeSettings" class="ghost">‚úï</button>
    </div>
    <div class="row" style="gap:10px; flex-wrap:wrap;">
      <label class="row" style="gap:6px;"><input id="holdToStart" type="checkbox"> Hold 500ms avant d√©marrage</label>
      <label class="row" style="gap:6px;"><input id="beepOnPB" type="checkbox" checked> Bip si PB</label>
      <label class="row" style="gap:6px;"><input id="autoSave" type="checkbox" checked> Sauvegarde auto √† l‚Äôarr√™t</label>
      <label class="row" style="gap:6px;">Inspection (s) <input id="inspSeconds" type="number" min="0" max="30" value="15" style="width:84px"></label>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ====== STATE (localStorage only) ====== */
const LS = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const appKey = 'ctimerx2';
const state = LS.get(appKey, {
  theme:'theme-cyan',
  profiles:[{id:'default', name:'Profil 1'}],
  currentProfile:'default',
  puzzle:'333',
  solves:{}, // key = profile::puzzle -> [ {t, dnf, p2, scr, ts} ]
  trainer:{ algs:[], ok:0, ko:0 },
  points:0,
  leagues:[100, 300, 700, 1500, 3000],
  settings:{ hold:false, beep:true, autosave:true, inspSec:15 },
  achievements:{ sub5:false, streak10:false }
});

/* ====== DOM ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const profileSelect=$('#profileSelect'), addProfileBtn=$('#addProfileBtn');
const puzzleSelect=$('#puzzleSelect'), themeSelect=$('#themeSelect');
const newScrambleBtn=$('#newScrambleBtn'), scrambleEl=$('#scramble');
const timerDisplay=$('#timerDisplay'), startStopBtn=$('#startStopBtn');
const inspectionToggle=$('#inspectionToggle'), inspSeconds=$('#inspSeconds'), inspSecLabel=$('#inspSecLabel');
const dnfBtn=$('#dnfBtn'), plus2Btn=$('#plus2Btn'), saveBtn=$('#saveBtn'), delLastBtn=$('#delLastBtn');
const pointsChip=$('#pointsChip'), leagueChip=$('#leagueChip'), trophyBar=$('#trophyBar'), trophyText=$('#trophyText');
const statLast=$('#stat-last'), statPB=$('#stat-pb'), statAo5=$('#stat-ao5'), statAo12=$('#stat-ao12'), recentList=$('#recentList');
const tabs=$$('.tabs button'); const settingsBtn=$('#settingsBtn'), settingsDlg=$('#settings'), closeSettings=$('#closeSettings');
const holdToStart=$('#holdToStart'), beepOnPB=$('#beepOnPB'), autoSave=$('#autoSave');
const exportBtn=$('#exportBtn'), importBtn=$('#importBtn'), importFile=$('#importFile'), historyList=$('#historyList');
const algName=$('#algName'), algMoves=$('#algMoves'), algScramble=$('#algScramble');
const saveAlgBtn=$('#saveAlgBtn'), clearAlgBtn=$('#clearAlgBtn'), algList=$('#algList');
const trainerScramble=$('#trainerScramble'), trainerSolution=$('#trainerSolution');
const trainerNew=$('#trainerNew'), trainerReveal=$('#trainerReveal'), trainerOk=$('#trainerOk'), trainerKo=$('#trainerKo');
const trainerOkRate=$('#trainerOkRate'), trainerKoRate=$('#trainerKoRate');
const modeBlind=$('#modeBlind'), modeEndu5=$('#modeEndu5'), modeEndu15=$('#modeEndu15'), modeEndu60=$('#modeEndu60'), modeChallenge=$('#modeChallenge'), stopModes=$('#stopModes');
const challengeInfo=$('#challengeInfo'), rewardBox=$('#rewardBox');
const tapZone=$('#tapZone'); const toast=$('#toast');

/* ====== Helpers ====== */
const keySolves=()=> state.currentProfile+'::'+state.puzzle;
const currentSolves=()=> state.solves[keySolves()] ?? [];
const setSolves=a=>{ state.solves[keySolves()]=a; saveState(); };
const addSolve=s=>{ const a=currentSolves(); a.push(s); setSolves(a); refreshStats(); };
const RNG=()=>Math.random();
const randInt=(a,b)=> a+Math.floor(RNG()*(b-a+1));
const choice=a=> a[randInt(0,a.length-1)];
const showToast = (msg)=>{ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1500); };
const saveState=()=> LS.set(appKey, state);

/* ====== Init ====== */
function init(){
  document.body.className=state.theme;
  themeSelect.value=state.theme; puzzleSelect.value=state.puzzle;
  inspSeconds.value = state.settings.inspSec||15; inspSecLabel.textContent=inspSeconds.value;
  renderProfiles(); refreshStats(); bindEvents(); setTimeout(()=>newScramble(),10);
}
function renderProfiles(){
  profileSelect.innerHTML='';
  state.profiles.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; profileSelect.appendChild(o); });
  profileSelect.value=state.currentProfile;
}

/* ====== Scrambles (WCA-like simplifi√©s) ====== */
const Scramble = {
  gen(p){
    switch(p){
      case '222': return this.nx(2,['R','U','F'],12);
      case '333': return this.nx(3,['R','L','U','D','F','B'],20);
      case '444': return this.nx(4,['R','L','U','D','F','B',"Rw","Lw","Uw","Dw","Fw","Bw"],40);
      case '555': return this.nx(5,['R','L','U','D','F','B',"Rw","Lw","Uw","Dw","Fw","Bw"],60);
      case '666': return this.nx(6,['R','L','U','D','F','B',"3Rw","3Lw","3Uw","3Dw","3Fw","3Bw","Rw","Lw","Uw","Dw","Fw","Bw"],80);
      case '777': return this.nx(7,['R','L','U','D','F','B',"3Rw","3Lw","3Uw","3Dw","3Fw","3Bw","Rw","Lw","Uw","Dw","Fw","Bw"],100);
      case 'pyram': return this.pyr();
      case 'skewb': return this.skewb();
      case 'mega': return this.mega();
      case 'clock': return this.clock();
      case 'sq1': return this.sq1();
    } return '‚Äî';
  },
  nx(n, moves, len){
    const mods=["","'","2"]; const ax=m=>m[0]; let last=null, out=[];
    for(let i=0;i<len;i++){ let m; do{ m=choice(moves);}while(ax(m)===last); last=ax(m); out.push(m+choice(mods)); }
    return out.join(' ');
  },
  pyr(){ const f=['U','L','R','B'], tips=['u','l','r','b'], mods=["","'"]; const s=[];
    for(let i=0;i<11;i++) s.push(choice(f)+choice(mods)); for(const t of tips) if(RNG()<.75) s.push(t+choice(mods)); return s.join(' ');
  },
  skewb(){ const m=['R','L','U','B'], mods=["","'"], s=[]; for(let i=0;i<11;i++) s.push(choice(m)+choice(mods)); return s.join(' '); },
  mega(){ const part=()=> choice(['R++','R--'])+' '+choice(['U++','U--']); const s=[]; for(let i=0;i<10;i++) s.push(part()); return s.join(' / '); },
  clock(){ const H=['UR','DR','UL','DL','U','R','L','D']; const step=()=> H.map(h=> h+(RNG()<.5?'+':'-')+randInt(0,5)).join(' ');
    const pins=['U','d','u','D']; return step()+' / '+choice(pins)+' / '+step(); },
  sq1(){ const part=()=> '('+randInt(-6,6)+','+randInt(-6,6)+')'; const L=randInt(25,30), s=[];
    for(let i=0;i<L;i++){ s.push(part()); if(i%2===0) s.push('/'); } return s.join(' '); }
};

/* ====== Timer ====== */
let running=false, startTs=0, holdArmed=false, inspectionLeft=0, mode=null;
let currentDNF=false, currentPlus2=false, currentScramble='';

function newScramble(){
  currentDNF=false; currentPlus2=false;
  currentScramble = Scramble.gen(state.puzzle);
  scrambleEl.textContent = currentScramble;
  if(mode?.type==='blind'){ scrambleEl.style.opacity=1; setTimeout(()=>{ if(mode?.type==='blind'){ scrambleEl.style.opacity=0; } }, 5000); }
  else scrambleEl.style.opacity=1;
}

function toggleTimer(){
  if(!running){
    if(inspectionToggle.checked && inspectionLeft<=0){
      inspectionLeft = (state.settings.inspSec||15)*1000;
      tickInspection(); return;
    }
    if(state.settings.hold){ holdArmed=true; timerDisplay.textContent='‚Äî'; setTimeout(()=>{ if(holdArmed) doStart(); },500); }
    else doStart();
  }else doStop();
}
function doStart(){ running=true; holdArmed=false; currentDNF=false; currentPlus2=false; startTs=performance.now(); loop(); }
function doStop(){
  running=false;
  const t=(performance.now()-startTs)/1000;
  const final = currentDNF? 'DNF' : (currentPlus2? t+2 : t);
  timerDisplay.textContent = formatTime(final);
  if(state.settings.autosave && !currentDNF) saveSolve();
  awardPoints(t); refreshStats();
}
function loop(){ if(!running) return; const t=(performance.now()-startTs)/1000; timerDisplay.textContent=formatTime(t); requestAnimationFrame(loop); }
function tickInspection(){
  if(inspectionLeft<=0){ inspectionLeft=0; timerDisplay.textContent='00.00'; doStart(); return; }
  timerDisplay.textContent='Inspect: '+Math.ceil(inspectionLeft/1000)+'s';
  inspectionLeft -= 100; setTimeout(tickInspection,100);
}
function formatTime(v){ if(v==='DNF') return 'DNF'; const t=+v; const m=Math.floor(t/60), s=t%60; return m>0? `${m}:${s.toFixed(2).padStart(5,'0')}` : s.toFixed(2); }
function markFlag(type){ if(type==='dnf') currentDNF=!currentDNF; if(type==='p2') currentPlus2=!currentPlus2; rewardBox.textContent='√âtat du solve: ' + (currentDNF?'DNF': currentPlus2?'+2':'OK'); }
function saveSolve(){
  const txt=timerDisplay.textContent;
  if(txt==='00.00' || txt==='DNF') return;
  addSolve({ t: parseFloat(txt), scr: currentScramble, ts: Date.now(), dnf: currentDNF?1:0, p2: currentPlus2?1:0 });
  renderHistory();
}
function delLast(){ const a=currentSolves(); a.pop(); setSolves(a); refreshStats(); }

/* ====== Stats ====== */
function refreshStats(){
  // ligues / points
  pointsChip.textContent='üèÜ '+state.points+' pts';
  const next = state.leagues.find(L=> state.points < L) ?? state.leagues.at(-1);
  const idx = state.leagues.findIndex(L=> L===next);
  leagueChip.textContent='Ligue '+(idx+1);
  const base=(idx===0?0:state.leagues[idx-1]), need=next-base, have=Math.min(state.points-base, need);
  trophyBar.style.width = Math.max(0,Math.min(100,(have/need)*100)).toFixed(1)+'%';
  trophyText.textContent=`${have} / ${need} pts pour Ligue ${idx+2}`;

  const arr=currentSolves();
  statLast.textContent = arr.length? formatTime(arr.at(-1).t) : '‚Äî';
  const valid = arr.filter(s=>!s.dnf).map(s=> s.p2? s.t+2 : s.t);
  statPB.textContent = valid.length? formatTime(Math.min(...valid)) : '‚Äî';
  statAo5.textContent = aoN(valid,5); statAo12.textContent = aoN(valid,12);
  recentList.innerHTML = '';
  arr.slice(-20).reverse().forEach(s=>{
    const d=document.createElement('div');
    d.innerHTML=`<span class="k">${formatTime(s.p2?(s.t+2):s.t)}</span><span class="v">${new Date(s.ts).toLocaleTimeString()} ¬∑ ${s.scr}</span>`;
    recentList.appendChild(d);
  });
}
function aoN(vals,N){ if(vals.length<N) return '‚Äî'; const last=vals.slice(-N).sort((a,b)=>a-b); const trimmed=last.slice(1,-1);
  const avg=trimmed.reduce((a,b)=>a+b,0)/trimmed.length; return avg.toFixed(2); }

/* ====== Modes & points ====== */
function setMode(m){
  mode=m;
  if(!m){ challengeInfo.textContent='Aucun mode actif.'; return; }
  if(m.type==='blind'){ challengeInfo.textContent='Blindfold actif : le scramble dispara√Æt apr√®s 5s.'; }
  if(m.type==='endu'){
    const mins=(m.ms/60000)|0; challengeInfo.textContent='Endurance '+mins+' minutes‚Ä¶';
    m.ends=Date.now()+m.ms; const tick=()=>{
      if(mode!==m) return;
      const left=m.ends-Date.now();
      if(left<=0){ mode=null; challengeInfo.textContent='Fin Endurance !'; showToast('Endurance termin√©e'); return; }
      challengeInfo.textContent='Endurance '+mins+' min ‚Ä¢ reste '+Math.ceil(left/1000)+'s';
      setTimeout(tick,500);
    }; tick();
  }
  if(m.type==='challenge'){
    m.level = m.level||1;
    challengeInfo.textContent='Challenge: Palier '+m.level+' ‚Ä¢ objectif '+targetForLevel(m.level)+'s';
  }
}
function targetForLevel(level){ return Math.max(25 - (level-1)*2, 8); } // objectif temps simple
function awardPoints(t){
  if(!t||typeof t!=='number') return;
  let pts=1;
  if(t<5) pts+=4; else if(t<10) pts+=2;
  if(mode?.type==='endu') pts+=1;
  if(mode?.type==='challenge'){
    const target=targetForLevel(mode.level); if(t<=target){ pts+=3; mode.level++; showToast('Palier +1 !'); setMode({type:'challenge', level:mode.level}); }
  }
  state.points+=pts; saveState();
  rewardBox.textContent = `+${pts} pts ‚Ä¢ GG !`;
  // succ√®s
  if(t<5 && !state.achievements.sub5){ state.achievements.sub5=true; showToast('Succ√®s: Sub‚Äë5 d√©bloqu√©!'); }
  updatePBBeep(t);
}
function updatePBBeep(t){
  const pb=getPB(); if(state.settings.beep && (pb===null || t<=pb)){ beep(); }
}
function getPB(){ const valid=currentSolves().filter(s=>!s.dnf).map(s=> s.p2? s.t+2 : s.t); return valid.length? Math.min(...valid) : null; }
function beep(){ try{ const C=new AudioContext(); const o=C.createOscillator(); const g=C.createGain();
  o.type='triangle'; o.frequency.value=880; o.connect(g); g.connect(C.destination);
  g.gain.value=0.0001; o.start(); g.gain.exponentialRampToValueAtTime(0.3, C.currentTime+0.02);
  setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, C.currentTime+0.1); o.stop(C.currentTime+0.12); },100);
}catch{} }

/* ====== Trainer ====== */
let currentAlg=null;
function renderAlgs(){
  algList.innerHTML='';
  state.trainer.algs.forEach(a=>{
    const d=document.createElement('div');
    d.innerHTML = `<span>${a.name}</span><span class="muted">${a.ok||0}‚úîÔ∏é / ${a.ko||0}‚úñÔ∏é</span>`;
    d.onclick=()=>{ currentAlg=a; algName.value=a.name; algMoves.value=a.moves; algScramble.value=a.scramble||''; trainerSolution.textContent='Solution masqu√©e'; trainerScramble.textContent=a.scramble||'(aucun scramble)'; };
    algList.appendChild(d);
  });
  trainerOkRate.textContent='OK: '+(state.trainer.ok||0);
  trainerKoRate.textContent='KO: '+(state.trainer.ko||0);
}
function trainerPick(){ if(!state.trainer.algs.length){ alert('Ajoute des algos d‚Äôabord.'); return; } currentAlg=choice(state.trainer.algs);
  trainerScramble.textContent=currentAlg.scramble||'(aucun scramble)'; trainerSolution.textContent='Solution masqu√©e'; }
function trainerMark(ok){ if(!currentAlg) return; currentAlg[ok?'ok':'ko']=(currentAlg[ok?'ok':'ko']||0)+1;
  state.trainer[ok?'ok':'ko']=(state.trainer[ok?'ok':'ko']||0)+1; saveState(); renderAlgs(); }

/* ====== Historique ====== */
function renderHistory(){
  const arr=currentSolves(); historyList.innerHTML='';
  arr.slice().reverse().forEach(s=>{ const d=document.createElement('div');
    d.innerHTML=`<span>${formatTime(s.p2?(s.t+2):s.t)} ${s.dnf?'(DNF)':''}</span><span class="muted">${new Date(s.ts).toLocaleString()} ¬∑ ${s.scr}</span>`;
    historyList.appendChild(d);
  });
}
function download(filename, text){
  try{
    const blob=new Blob([text],{type:'application/json'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.style.display='none'; document.body.appendChild(a);
    if(navigator.canShare && navigator.canShare({ files:[new File([blob], filename, {type:'application/json'})] })){
      const file=new File([blob], filename, {type:'application/json'});
      navigator.share({ files:[file], title:filename, text:'Export solves' }).catch(()=> a.click());
    }else{ a.click(); }
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },500);
  }catch(e){
    const w=window.open('','_blank'); if(w&&w.document){ w.document.write('<pre>'+text.replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]))+'</pre>'); w.document.close(); }
    else alert('Export √©chou√©, copie/colle le JSON manuellement.');
  }
}

/* ====== Bindings ====== */
function bindEvents(){
  themeSelect.onchange=()=>{ state.theme=themeSelect.value; document.body.className=state.theme; saveState(); };
  puzzleSelect.onchange=()=>{ state.puzzle=puzzleSelect.value; saveState(); newScramble(); refreshStats(); };
  addProfileBtn.onclick=()=>{ const name=prompt('Nom du profil ?'); if(!name) return; const id='p'+Math.random().toString(36).slice(2,8);
    state.profiles.push({id,name}); state.currentProfile=id; saveState(); renderProfiles(); refreshStats(); };
  profileSelect.onchange=()=>{ state.currentProfile=profileSelect.value; saveState(); refreshStats(); };

  newScrambleBtn.onclick=newScramble;
  startStopBtn.onclick=toggleTimer;
  tapZone.addEventListener('click', (e)=>{ // tap milieu √©cran
    if (!e.target.closest('button') && !e.target.closest('input') && !e.target.closest('textarea') && !e.target.closest('select')) toggleTimer();
  });
  document.addEventListener('keydown', e=>{ if(e.code==='Space' && !e.repeat){ e.preventDefault(); toggleTimer(); } });

  dnfBtn.onclick=()=>markFlag('dnf');
  plus2Btn.onclick=()=>markFlag('p2');
  saveBtn.onclick=saveSolve;
  delLastBtn.onclick=delLast;

  tabs.forEach(b=> b.onclick=()=>{ tabs.forEach(x=>x.classList.toggle('active',x===b));
    ['timer','trainer','challenge','history'].forEach(id=> $('#tab-'+id).style.display=(b.dataset.tab===id?'block':'none'));
    if(b.dataset.tab==='history') renderHistory();
  });

  settingsBtn.onclick=()=>{ settingsDlg.style.display='flex';
    holdToStart.checked=!!state.settings.hold; beepOnPB.checked=!!state.settings.beep; autoSave.checked=!!state.settings.autosave;
    inspSeconds.value=state.settings.inspSec||15; inspSecLabel.textContent=inspSeconds.value;
  };
  closeSettings.onclick=()=> settingsDlg.style.display='none';
  holdToStart.onchange=()=>{ state.settings.hold=holdToStart.checked; saveState(); };
  beepOnPB.onchange=()=>{ state.settings.beep=beepOnPB.checked; saveState(); };
  autoSave.onchange=()=>{ state.settings.autosave=autoSave.checked; saveState(); };
  inspSeconds.onchange=()=>{ state.settings.inspSec=Math.max(0,Math.min(30, +inspSeconds.value||0)); inspSecLabel.textContent=state.settings.inspSec; saveState(); };

  // Trainer
  saveAlgBtn.onclick=()=>{ const name=algName.value.trim(), mv=algMoves.value.trim(), sc=algScramble.value.trim();
    if(!name||!mv) return alert('Nom + mouvements requis');
    const ex=state.trainer.algs.find(a=>a.name===name);
    if(ex){ ex.moves=mv; ex.scramble=sc; } else { state.trainer.algs.push({name, moves:mv, scramble:sc, ok:0, ko:0}); }
    saveState(); renderAlgs();
  };
  clearAlgBtn.onclick=()=>{ algName.value=''; algMoves.value=''; algScramble.value=''; };
  trainerNew.onclick=trainerPick;
  trainerReveal.onclick=()=> trainerSolution.textContent = currentAlg ? currentAlg.moves : '‚Äî';
  trainerOk.onclick=()=> trainerMark(true);
  trainerKo.onclick=()=> trainerMark(false);

  // Modes
  modeBlind.onclick=()=> setMode({type:'blind'});
  modeEndu5.onclick=()=> setMode({type:'endu', ms:5*60000});
  modeEndu15.onclick=()=> setMode({type:'endu', ms:15*60000});
  modeEndu60.onclick=()=> setMode({type:'endu', ms:60*60000});
  modeChallenge.onclick=()=> setMode({type:'challenge', level: (mode?.type==='challenge'? mode.level : 1)});
  stopModes.onclick=()=> setMode(null);

  // Export/Import
  exportBtn.onclick=()=>{ const data=JSON.stringify(currentSolves(),null,2); download('solves-'+Date.now()+'.json', data); };
  importBtn.onclick=()=> importFile.click();
  importFile.onchange=()=>{ const f=importFile.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); setSolves(Array.isArray(data)?data:[]); refreshStats(); alert('Import OK'); }
      catch{ alert('Fichier invalide'); } }; r.readAsText(f); };
}

/* ====== Start ====== */
init(); bindEvents(); renderAlgs(); renderHistory();
</script>
</body>
</html>
