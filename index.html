<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Cuber Mini Timer</title>
<style>
  :root{--bg:#0b0e11;--fg:#e7eaf0;--muted:#9aa3ad;--accent:#6ee7b7;--accent2:#93c5fd;--card:#12161b;--warn:#fcd34d;--bad:#f87171;}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:14px 14px 90px}
  h1{font-size:18px;margin:4px 0 10px;color:var(--fg);opacity:.9}
  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{flex:1;padding:10px 12px;border-radius:12px;background:var(--card);color:var(--muted);text-align:center;border:1px solid #1b2129}
  .tab.active{color:var(--fg);border-color:#2b3441;background:linear-gradient(180deg,#131920,#0e1318)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{flex:1;min-width:260px;background:var(--card);border:1px solid #1b2129;border-radius:14px;padding:12px}
  .scramble{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:16px;line-height:1.3;word-wrap:break-word}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#16202a;color:var(--muted);font-size:12px;margin-right:6px}
  .btn{padding:11px 14px;border-radius:12px;border:1px solid #2b3441;background:#11161c;color:var(--fg);font-weight:600;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(180deg,#18302a,#14241f);border-color:#204237;color:#b9f8df}
  .btn.ghost{background:transparent}
  .btn.warn{border-color:#3a300b;color:var(--warn);background:#171309}
  .btn.bad{border-color:#3a0b0b;color:var(--bad);background:#170909}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .bigtime{font-size:64px;text-align:center;margin:6px 0 2px;font-variant-numeric:tabular-nums}
  .inspect{font-size:22px;text-align:center;color:var(--warn);min-height:28px}
  .little{font-size:13px;color:var(--muted)}
  .list{max-height:280px;overflow:auto;border-top:1px dashed #28303a;margin-top:8px;padding-top:8px}
  .rowline{display:flex;gap:6px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #1f2730}
  .rowline:last-child{border-bottom:none}
  .statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px}
  .stat{padding:8px;border:1px solid #2b3441;border-radius:10px;text-align:center;background:#0e141a}
  .stat b{display:block;font-size:18px;margin-top:2px;color:var(--accent)}
  .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(9,12,15,.9);backdrop-filter:blur(8px);border-top:1px solid #1b2129;padding:10px 12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  .toggle{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
  input[type="checkbox"]{transform:scale(1.1)}
  textarea{width:100%;min-height:44px;background:#0f141a;border:1px solid #1e2731;border-radius:10px;color:var(--fg);padding:8px}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>⏱️ Cuber Mini Timer — 2×2 · 3×3 · Skewb</h1>

  <div class="tabs" id="tabs">
    <button class="tab active" data-cat="2x2">2×2</button>
    <button class="tab" data-cat="3x3">3×3</button>
    <button class="tab" data-cat="skewb">Skewb</button>
  </div>

  <div class="row">
    <div class="card">
      <div class="pill">Scramble</div>
      <div id="scramble" class="scramble">—</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="newScramble">Nouveau scramble</button>
        <label class="toggle"><input type="checkbox" id="inspection" checked/> Inspection 15s</label>
        <label class="toggle"><input type="checkbox" id="tapStart" checked/> Tap pour démarrer</label>
      </div>
      <div class="little" style="margin-top:6px">Astuce : appuie sur l’**écran** (ou barre d’espace sur PC) pour start/stop.</div>
    </div>

    <div class="card">
      <div class="pill">Timer</div>
      <div id="inspect" class="inspect"></div>
      <div id="time" class="bigtime">0.000</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:4px">
        <button class="btn primary" id="startStop">Start</button>
        <button class="btn ghost" id="plus2">+2</button>
        <button class="btn bad" id="dnf">DNF</button>
        <button class="btn" id="save">Save</button>
      </div>
      <div style="margin-top:8px">
        <textarea id="note" placeholder="Note rapide (cas, erreur, prise, etc.)"></textarea>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:10px">
    <div class="card">
      <div class="pill">Résultats</div>
      <div class="list" id="results"></div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="btn warn" id="reset">Reset session</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
      </div>
    </div>

    <div class="card">
      <div class="pill">Stats</div>
      <div class="statgrid">
        <div class="stat"><span>Mo3</span><b id="mo3">—</b></div>
        <div class="stat"><span>Ao5</span><b id="ao5">—</b></div>
        <div class="stat"><span>Ao12</span><b id="ao12">—</b></div>
        <div class="stat"><span>Best</span><b id="best">—</b></div>
      </div>
      <div class="pill" style="margin-top:10px">Catégorie</div>
      <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
        <select id="catSel" class="btn">
          <option value="2x2">2×2</option>
          <option value="3x3">3×3</option>
          <option value="skewb">Skewb</option>
        </select>
        <button class="btn" id="newSession">Nouvelle session</button>
      </div>
      <div class="little" style="margin-top:6px">Les sessions sont **sauvegardées localement** par catégorie.</div>
    </div>
  </div>
</div>

<div class="footer">
  <button class="btn" id="copyScramble">Copier scramble</button>
  <button class="btn" id="prevScramble">⟵</button>
  <button class="btn" id="nextScramble">⟶</button>
</div>

<script>
/* ---------- utils ---------- */
const $$ = sel => document.querySelector(sel);
const nowMs = () => performance.now();

/* ---------- state ---------- */
let category = '2x2';
let running = false, startT = 0, elapsed = 0, inspLeft = 0, inspTick = null, timeRAF = null;
let pendingPlus2 = false, pendingDNF = false;
let scrambleHistory = [], scrambleIdx = -1;

/* ---------- storage ---------- */
function storeKey(){ return 'cuber_timer_v1_' + category; }
function loadSession(){
  try{ return JSON.parse(localStorage.getItem(storeKey())||'[]'); }catch(e){ return []; }
}
function saveSession(arr){
  localStorage.setItem(storeKey(), JSON.stringify(arr));
}

/* ---------- scrambles ---------- */
function rand(n){ return Math.floor(Math.random()*n); }
const moves3 = ["U","D","L","R","F","B"];
const mods = ["","'","2"];
function gen3x3(len=25){
  let seq=[], lastAxis=null;
  const axisMap = {U:'U',D:'U',L:'L',R:'L',F:'F',B:'F'};
  while(seq.length<len){
    const m = moves3[rand(6)];
    const ax = axisMap[m];
    if(ax===lastAxis) continue;
    lastAxis = ax;
    seq.push(m+mods[rand(3)]);
  }
  return seq.join(' ');
}
function gen2x2(len=9){ // moves sans tranches
  const m2 = ["U","R","F"]; // suffisant et standard
  let seq=[], last=null;
  while(seq.length<len){
    const m = m2[rand(3)];
    if(m===last) continue;
    last = m;
    seq.push(m+mods[rand(3)]);
  }
  return seq.join(' ');
}
function genSkewb(len=12){
  const m = ["R","L","U","B"]; // notations courantes
  let seq=[], last=null;
  while(seq.length<len){
    const x = m[rand(4)];
    if(x===last) continue;
    last = x;
    seq.push(x+(['','\''])[rand(2)]);
  }
  return seq.join(' ');
}
function makeScramble(){
  let s = '—';
  if(category==='2x2') s = gen2x2();
  else if(category==='3x3') s = gen3x3();
  else s = genSkewb();
  scrambleHistory.push(s);
  scrambleIdx = scrambleHistory.length-1;
  $$('#scramble').textContent = s;
}
function showScrambleAt(i){
  if(i>=0 && i<scrambleHistory.length){
    scrambleIdx = i;
    $$('#scramble').textContent = scrambleHistory[i];
  }
}

/* ---------- timer ---------- */
function fmt(ms){
  if(ms<=0) return '0.000';
  const s = ms/1000;
  const m = Math.floor(s/60);
  const ss = s%60;
  if(m>0) return `${m}:${ss.toFixed(3).padStart(6,'0')}`;
  return ss.toFixed(3);
}
function tick(){
  const t = nowMs();
  $$('#time').textContent = fmt(t-startT+elapsed);
  timeRAF = requestAnimationFrame(tick);
}
function startTimer(){
  if($$('#inspection').checked && inspLeft>0){
    // ignorer si inspection en cours
    return;
  }
  running = true;
  startT = nowMs();
  timeRAF = requestAnimationFrame(tick);
  $$('#startStop').textContent = 'Stop';
}
function stopTimer(save=true){
  running = false;
  cancelAnimationFrame(timeRAF);
  timeRAF = null;
  const t = nowMs() - startT + elapsed;
  elapsed = 0;
  $$('#startStop').textContent = 'Start';
  if(save) addResult(t);
}
function startInspection(){
  inspLeft = 15;
  $$('#inspect').textContent = 'Inspection: 15';
  inspTick = setInterval(()=>{
    inspLeft--;
    if(inspLeft<=0){
      clearInterval(inspTick); inspTick=null; inspLeft=0;
      $$('#inspect').textContent = '+2 (dépassement) après 2s';
      // si 2s de plus, forcer +2
      setTimeout(()=>{
        if(!running && !startT){ // pas démarré
          pendingPlus2 = true;
          $$('#inspect').textContent = 'Inspection dépassée: +2 appliqué';
        }
      },2000);
    }else{
      $$('#inspect').textContent = 'Inspection: '+inspLeft;
    }
  },1000);
}
function resetInspectionUI(){
  clearInterval(inspTick); inspTick=null; inspLeft=0; $$('#inspect').textContent='';
}

/* ---------- results ---------- */
function addResult(ms){
  const arr = loadSession();
  let time = ms;
  let dnf = pendingDNF;
  let plus2 = pendingPlus2;
  if(plus2) time += 2000;
  const note = $$('#note').value.trim();
  arr.push({t:time, raw:ms, dnf, plus2, sc: $$('#scramble').textContent, note, at: Date.now()});
  saveSession(arr);
  pendingPlus2=false; pendingDNF=false; $$('#note').value='';
  render();
  makeScramble();
}
function delResult(i){
  const arr = loadSession();
  arr.splice(i,1);
  saveSession(arr);
  render();
}
function resLabel(r){
  if(r.dnf) return 'DNF';
  const base = fmt(r.t);
  return r.plus2 ? base+' (+2)' : base;
}
function avgOf(arr, n){
  if(arr.length<n) return '—';
  const last = arr.slice(-n);
  // WCA: drop best & worst (except DNF logic simplified: DNF => ignore avg)
  if(last.some(x=>x.dnf)) return 'DNF';
  const vals = last.map(x=>x.t).slice().sort((a,b)=>a-b);
  const use = vals.slice(1, vals.length-1);
  const avg = use.reduce((s,x)=>s+x,0)/use.length;
  return fmt(avg);
}
function meanOf(arr, n){
  if(arr.length<n) return '—';
  const last = arr.slice(-n);
  if(last.some(x=>x.dnf)) return 'DNF';
  const avg = last.reduce((s,x)=>s+x.t,0)/n;
  return fmt(avg);
}
function bestSingle(arr){
  const ok = arr.filter(x=>!x.dnf);
  if(!ok.length) return '—';
  return fmt(Math.min(...ok.map(x=>x.t)));
}
function render(){
  // stats
  const arr = loadSession();
  $$('#mo3').textContent = meanOf(arr,3);
  $$('#ao5').textContent = avgOf(arr,5);
  $$('#ao12').textContent = avgOf(arr,12);
  $$('#best').textContent = bestSingle(arr);

  // list
  const el = $$('#results');
  el.innerHTML = '';
  arr.slice().reverse().forEach((r,idx)=>{
    const i = arr.length-1-idx;
    const row = document.createElement('div');
    row.className = 'rowline';
    row.innerHTML = `
      <div>
        <div><b>${resLabel(r)}</b> <span class="little">• ${r.sc}</span></div>
        ${r.note?`<div class="little">📝 ${r.note}</div>`:''}
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost" data-act="toggle+2" data-i="${i}">+2</button>
        <button class="btn ghost" data-act="toggleDNF" data-i="${i}">DNF</button>
        <button class="btn bad" data-act="del" data-i="${i}">×</button>
      </div>
    `;
    el.appendChild(row);
  });
}

/* ---------- actions ---------- */
function togglePlus2(i){
  const arr = loadSession();
  const r = arr[i]; if(!r) return;
  if(r.dnf){ r.dnf=false; } // enlever DNF si on met +2
  r.plus2 = !r.plus2;
  r.t = r.plus2 ? r.raw+2000 : r.raw;
  saveSession(arr); render();
}
function toggleDNF(i){
  const arr = loadSession();
  const r = arr[i]; if(!r) return;
  r.dnf = !r.dnf;
  saveSession(arr); render();
}

/* ---------- export/import ---------- */
function exportSession(){
  const payload = {
    v:1, category, data: loadSession()
  };
  const text = JSON.stringify(payload, null, 2);
  navigator.clipboard.writeText(text).then(()=>alert('Export copié dans le presse‑papiers ✅'));
}
function importSession(){
  const text = prompt('Colle ici l’export JSON :');
  if(!text) return;
  try{
    const obj = JSON.parse(text);
    if(obj && obj.v===1 && Array.isArray(obj.data)){
      saveSession(obj.data);
      render();
      alert('Import réussi ✅');
    }else{
      alert('Format invalide');
    }
  }catch(e){ alert('JSON invalide'); }
}

/* ---------- init ---------- */
function setCategory(cat){
  category = cat;
  $$('#catSel').value = cat;
  [...document.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active', b.dataset.cat===cat));
  scrambleHistory = []; scrambleIdx = -1;
  render();
  makeScramble();
  resetInspectionUI();
}
function newSession(){
  if(confirm('Réinitialiser la session de '+category+' ?')){ saveSession([]); render(); }
}

/* ---------- listeners ---------- */
document.addEventListener('keydown', e=>{
  if(e.code==='Space'){ e.preventDefault(); if(running) stopTimer(); else handleStart(); }
});
document.addEventListener('click', e=>{
  const a = e.target.closest('[data-act]');
  if(a){
    const i = +a.dataset.i;
    if(a.dataset.act==='del') delResult(i);
    if(a.dataset.act==='$'){}
    if(a.dataset.act==='toggle+2') togglePlus2(i);
    if(a.dataset.act==='toggleDNF') toggleDNF(i);
  }
});
$$('#tabs').addEventListener('click', e=>{
  const b = e.target.closest('.tab'); if(!b) return;
  setCategory(b.dataset.cat);
});
$$('#catSel').addEventListener('change', e=>setCategory(e.target.value));
$$('#newScramble').addEventListener('click', makeScramble);
$$('#copyScramble').addEventListener('click', ()=>{
  navigator.clipboard.writeText($$('#scramble').textContent);
});
$$('#prevScramble').addEventListener('click', ()=>showScrambleAt(scrambleIdx-1));
$$('#nextScramble').addEventListener('click', ()=>showScrambleAt(scrambleIdx+1));
$$('#newSession').addEventListener('click', newSession);
$$('#exportBtn').addEventListener('click', exportSession);
$$('#importBtn').addEventListener('click', importSession);

function handleStart(){
  if($$('#inspection').checked){
    resetInspectionUI();
    startInspection();
    startT = 0; elapsed = 0;
    pendingPlus2=false; pendingDNF=false;
  }else{
    startT = nowMs(); elapsed = 0;
    pendingPlus2=false; pendingDNF=false;
    startTimer();
  }
}
$$('#startStop').addEventListener('click', ()=>{ if(running) stopTimer(); else handleStart(); });
$$('#plus2').addEventListener('click', ()=>{ if(running){ pendingPlus2=!pendingPlus2; }});
$$('#dnf').addEventListener('click', ()=>{ if(running){ pendingDNF=!pendingDNF; }});
$$('#save').addEventListener('click', ()=>{ if(running){ stopTimer(true); }});

if($$('#tapStart')){
  document.addEventListener('touchstart', (e)=>{
    // tap global = start/stop (éviter boutons)
    const withinButton = e.target.closest('button,select,textarea,input,label');
    if(withinButton) return;
    if(running) stopTimer(); else handleStart();
  }, {passive:true});
}

/* boot */
setCategory('2x2');
</script>
</body>
</html>
